!function(e){var t={cloud:{}};!function(e){var t={exports:{}},n={};!function(e){var i,r={NOT_RESOLVED:"NOT_RESOLVED",IN_RESOLVING:"IN_RESOLVING",RESOLVED:"RESOLVED"},o=function(){var t={trackCircularDependencies:!0,allowMultipleDeclarations:!0},n={},h=!1,p=[],_=function(e,t,o){o||(o=t,t=[]);var s=n[e];s||(s=n[e]={name:e,decl:i}),s.decl={name:e,prev:s.decl,fn:o,state:r.NOT_RESOLVED,deps:t,dependents:[],exports:i}},v=function(t,n,i){"string"==typeof t&&(t=[t]),h||(h=!0,f(b)),p.push({deps:t,cb:function(t,r){r?(i||s)(r):n.apply(e,t)}})},y=function(e){var t=n[e];return t?r[t.decl.state]:"NOT_DEFINED"},m=function(e){return!!n[e]},g=function(e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},b=function(){h=!1,w()},w=function(){var e,t=p,n=0;for(p=[];e=t[n++];)E(null,e.deps,[],e.cb)},E=function(e,i,o,s){var u=i.length;u||s([]);for(var d,f,h=[],p=0,_=u;_>p;){if(d=i[p++],"string"==typeof d){if(!n[d])return void s(null,a(d,e));f=n[d].decl}else f=d;if(f.state===r.IN_RESOLVING&&t.trackCircularDependencies&&l(f,o))return void s(null,c(f,o));h.push(f),R(f,o,function(e,t){if(t)return void s(null,t);if(!--u){for(var n,i=[],r=0;n=h[r++];)i.push(n.exports);s(i)}})}},R=function(n,i,o){if(n.state===r.RESOLVED)return void o(n.exports);if(n.dependents.push(o),n.state!==r.IN_RESOLVING){if(n.prev&&!t.allowMultipleDeclarations)return void k(n,d(n));t.trackCircularDependencies&&(i=i.slice()).push(n);var s=!1,a=n.prev?n.deps.concat([n.prev]):n.deps;n.state=r.IN_RESOLVING,E(n,a,i,function(t,i){return i?void k(n,i):(t.unshift(function(e,t){return s?void o(null,u(n)):(s=!0,void(t?k(n,t):x(n,e)))}),void n.fn.apply({name:n.name,deps:n.deps,global:e},t))})}},x=function(e,t){e.exports=t,e.state=r.RESOLVED;for(var n,o=0;n=e.dependents[o++];)n(t);e.dependents=i},k=function(e,t){e.state=r.NOT_RESOLVED;for(var n,i=0;n=e.dependents[i++];)n(null,t);e.dependents=[]};return{create:o,define:_,require:v,getState:y,isDefined:m,setOptions:g}},s=function(e){f(function(){throw e})},a=function(e,t){return Error(t?'Module "'+t.name+'": can\'t resolve dependence "'+e+'"':'Required module "'+e+"\" can't be resolved")},c=function(e,t){for(var n,i=[],r=0;n=t[r++];)i.push(n.name);return i.push(e.name),Error('Circular dependence has been detected: "'+i.join(" -> ")+'"')},u=function(e){return Error('Declaration of module "'+e.name+'" has already been provided')},d=function(e){return Error('Multiple declarations of module "'+e.name+'" have been detected')},l=function(e,t){for(var n,i=0;n=t[i++];)if(e===n)return!0;return!1},f=function(){var t=[],n=function(e){return 1===t.push(e)},i=function(){var e=t,n=0,i=t.length;for(t=[];i>n;)e[n++]()};if("object"==typeof process&&process.nextTick)return function(e){n(e)&&process.nextTick(i)};if(e.setImmediate)return function(t){n(t)&&e.setImmediate(i)};if(e.postMessage&&!e.opera){var r=!0;if(e.attachEvent){var o=function(){r=!1};e.attachEvent("onmessage",o),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",o)}if(r){var s="__modules"+ +new Date,a=function(e){e.data===s&&(e.stopPropagation&&e.stopPropagation(),i())};return e.addEventListener?e.addEventListener("message",a,!0):e.attachEvent("onmessage",a),function(t){n(t)&&e.postMessage(s,"*")}}}var c=e.document;if("onreadystatechange"in c.createElement("script")){var u=c.getElementsByTagName("head")[0],d=function(){var e=c.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,i()},u.appendChild(e)};return function(e){n(e)&&d()}}return function(e){n(e)&&setTimeout(i,0)}}();"object"==typeof n?t.exports=o():e.modules=o()}(this),e.modules=t.exports}(t),function(e){var t={exports:{}};!function(e){var n,i=function(){var t=[],n=function(e){return 1===t.push(e)},i=function(){var e=t,n=0,i=t.length;for(t=[];i>n;)e[n++]()};if("function"==typeof setImmediate)return function(e){n(e)&&setImmediate(i)};if("object"==typeof process&&process.nextTick)return function(e){n(e)&&process.nextTick(i)};if(e.postMessage){var r=!0;if(e.attachEvent){var o=function(){r=!1};e.attachEvent("onmessage",o),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",o)}if(r){var s="__promise"+ +new Date,a=function(e){e.data===s&&(e.stopPropagation&&e.stopPropagation(),i())};return e.addEventListener?e.addEventListener("message",a,!0):e.attachEvent("onmessage",a),function(t){n(t)&&e.postMessage(s,"*")}}}var c=e.document;if("onreadystatechange"in c.createElement("script")){var u=function(){var e=c.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,i()},(c.documentElement||c.body).appendChild(e)};return function(e){n(e)&&u()}}return function(e){n(e)&&setTimeout(i,0)}}(),r=function(e){i(function(){throw e})},o=function(e){return"function"==typeof e},s=function(e){return null!==e&&"object"==typeof e},a=Object.prototype.toString,c=Array.isArray||function(e){return"[object Array]"===a.call(e)},u=function(e){for(var t=[],n=0,i=e.length;i>n;)t.push(n++);return t},d=Object.keys||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},l=function(e){var t=function(t){this.name=e,this.message=t};return t.prototype=new Error,t},f=function(e,t){return function(n){e.call(this,n,t)}},h=function(){this._promise=new _};h.prototype={promise:function(){return this._promise},resolve:function(e){this._promise.isResolved()||this._promise._resolve(e)},reject:function(e){this._promise.isResolved()||(m.isPromise(e)?(e=e.then(function(e){var t=m.defer();return t.reject(e),t.promise()}),this._promise._resolve(e)):this._promise._reject(e))},notify:function(e){this._promise.isResolved()||this._promise._notify(e)}};var p={PENDING:0,RESOLVED:1,FULFILLED:2,REJECTED:3},_=function(e){if(this._value=n,this._status=p.PENDING,this._fulfilledCallbacks=[],this._rejectedCallbacks=[],this._progressCallbacks=[],e){var t=this,i=e.length;e(function(e){t.isResolved()||t._resolve(e)},i>1?function(e){t.isResolved()||t._reject(e)}:n,i>2?function(e){t.isResolved()||t._notify(e)}:n)}};_.prototype={valueOf:function(){return this._value},isResolved:function(){return this._status!==p.PENDING},isFulfilled:function(){return this._status===p.FULFILLED},isRejected:function(){return this._status===p.REJECTED},then:function(e,t,n,i){var r=new h;return this._addCallbacks(r,e,t,n,i),r.promise()},"catch":function(e,t){return this.then(n,e,t)},fail:function(e,t){return this.then(n,e,t)},always:function(e,t){var n=this,i=function(){return e.call(this,n)};return this.then(i,i,t)},progress:function(e,t){return this.then(n,n,e,t)},spread:function(e,t,n){return this.then(function(t){return e.apply(this,t)},t,n)},done:function(e,t,n,i){this.then(e,t,n,i).fail(r)},delay:function(e){var t,n=this.then(function(n){var i=new h;return t=setTimeout(function(){i.resolve(n)},e),i.promise()});return n.always(function(){clearTimeout(t)}),n},timeout:function(e){var t=new h,n=setTimeout(function(){t.reject(new m.TimedOutError("timed out"))},e);return this.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise().always(function(){clearTimeout(n)}),t.promise()},_vow:!0,_resolve:function(e){if(!(this._status>p.RESOLVED)){if(e===this)return void this._reject(TypeError("Can't resolve promise with itself"));if(this._status=p.RESOLVED,e&&e._vow)return void(e.isFulfilled()?this._fulfill(e.valueOf()):e.isRejected()?this._reject(e.valueOf()):e.then(this._fulfill,this._reject,this._notify,this));if(s(e)||o(e)){var t;try{t=e.then}catch(n){return void this._reject(n)}if(o(t)){var i=this,r=!1;try{t.call(e,function(e){r||(r=!0,i._resolve(e))},function(e){r||(r=!0,i._reject(e))},function(e){i._notify(e)})}catch(n){r||this._reject(n)}return}}this._fulfill(e)}},_fulfill:function(e){this._status>p.RESOLVED||(this._status=p.FULFILLED,this._value=e,this._callCallbacks(this._fulfilledCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=n)},_reject:function(e){this._status>p.RESOLVED||(this._status=p.REJECTED,this._value=e,this._callCallbacks(this._rejectedCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=n)},_notify:function(e){this._callCallbacks(this._progressCallbacks,e)},_addCallbacks:function(e,t,i,r,s){i&&!o(i)?(s=i,i=n):r&&!o(r)&&(s=r,r=n);var a;this.isRejected()||(a={defer:e,fn:o(t)?t:n,ctx:s},this.isFulfilled()?this._callCallbacks([a],this._value):this._fulfilledCallbacks.push(a)),this.isFulfilled()||(a={defer:e,fn:i,ctx:s},this.isRejected()?this._callCallbacks([a],this._value):this._rejectedCallbacks.push(a)),this._status<=p.RESOLVED&&this._progressCallbacks.push({defer:e,fn:r,ctx:s})},_callCallbacks:function(e,t){var n=e.length;if(n){var r=this.isResolved(),o=this.isFulfilled();i(function(){for(var i,s,a,c=0;n>c;)if(i=e[c++],s=i.defer,a=i.fn){var u,d=i.ctx;try{u=d?a.call(d,t):a(t)}catch(l){s.reject(l);continue}r?s.resolve(u):s.notify(u)}else r?o?s.resolve(t):s.reject(t):s.notify(t)})}}};var v={cast:function(e){return m.cast(e)},all:function(e){return m.all(e)},race:function(e){return m.anyResolved(e)},resolve:function(e){return m.resolve(e)},reject:function(e){return m.reject(e)}};for(var y in v)v.hasOwnProperty(y)&&(_[y]=v[y]);var m={Deferred:h,Promise:_,defer:function(){return new h},when:function(e,t,n,i,r){return m.cast(e).then(t,n,i,r)},fail:function(e,t,i){return m.when(e,n,t,i)},always:function(e,t,n){return m.when(e).always(t,n)},progress:function(e,t,n){return m.when(e).progress(t,n)},spread:function(e,t,n,i){return m.when(e).spread(t,n,i)},done:function(e,t,n,i,r){m.when(e).done(t,n,i,r)},isPromise:function(e){return s(e)&&o(e.then)},cast:function(e){return m.isPromise(e)?e:m.resolve(e)},valueOf:function(e){return e&&o(e.valueOf)?e.valueOf():e},isFulfilled:function(e){return e&&o(e.isFulfilled)?e.isFulfilled():!0},isRejected:function(e){return e&&o(e.isRejected)?e.isRejected():!1},isResolved:function(e){return e&&o(e.isResolved)?e.isResolved():!0},resolve:function(e){var t=m.defer();return t.resolve(e),t.promise()},fulfill:function(e){var t=m.defer(),n=t.promise();return t.resolve(e),n.isFulfilled()?n:n.then(null,function(e){return e})},reject:function(e){var t=m.defer();return t.reject(e),t.promise()},invoke:function(t){var n,i=Math.max(arguments.length-1,0);if(i){n=Array(i);for(var r=0;i>r;)n[r++]=arguments[r]}try{return m.resolve(n?t.apply(e,n):t.call(e))}catch(o){return m.reject(o)}},all:function(e){var t=new h,n=c(e),i=n?u(e):d(e),r=i.length,o=n?[]:{};if(!r)return t.resolve(o),t.promise();var s=r;return m._forEach(e,function(e,n){o[i[n]]=e,--s||t.resolve(o)},t.reject,t.notify,t,i),t.promise()},allResolved:function(e){var t=new h,n=c(e),i=n?u(e):d(e),r=i.length,o=n?[]:{};if(!r)return t.resolve(o),t.promise();var s=function(){--r||t.resolve(e)};return m._forEach(e,s,s,t.notify,t,i),t.promise()},allPatiently:function(e){return m.allResolved(e).then(function(){var t,n,i,r,o=c(e),s=o?u(e):d(e),a=s.length,l=0;if(!a)return o?[]:{};for(;a>l;)i=s[l++],r=e[i],m.isRejected(r)?(t||(t=o?[]:{}),o?t.push(r.valueOf()):t[i]=r.valueOf()):t||((n||(n=o?[]:{}))[i]=m.valueOf(r));if(t)throw t;return n})},any:function(e){var t=new h,n=e.length;if(!n)return t.reject(Error()),t.promise();var i,r=0;return m._forEach(e,t.resolve,function(e){r||(i=e),++r===n&&t.reject(i)},t.notify,t),t.promise()},anyResolved:function(e){var t=new h,n=e.length;return n?(m._forEach(e,t.resolve,t.reject,t.notify,t),t.promise()):(t.reject(Error()),t.promise())},delay:function(e,t){return m.resolve(e).delay(t)},timeout:function(e,t){return m.resolve(e).timeout(t)},_forEach:function(e,t,n,i,r,o){for(var s=o?o.length:e.length,a=0;s>a;)m.when(e[o?o[a]:a],f(t,a),n,i,r),++a},TimedOutError:l("TimedOut")},g=!0;"object"==typeof t&&"object"==typeof t.exports&&(t.exports=m,g=!1),"object"==typeof modules&&(modules.define("vow",function(e){e(m)}),g=!1),"function"==typeof define&&(define(function(e,t,n){n.exports=m}),g=!1),g&&(e.vow=m)}(this),e.vow=t.exports,e.modules.define("vow",function(t){t(e.vow)})}(t);var n=function(){this._initialized=!1,this._key=null,this._token=null};if(n.prototype.initialize=function(e){var n=t.vow.defer();return t.modules.require(["cloud.dataSyncApi.config","component.util","cloud.Error","vow","global"],function(t,i,r,o,s){if(e)if(e.key||e.token||e.with_credentials)if(e.token)this._token=e.token,this._initialized=!0,n.resolve();else if(e.with_credentials)this._withCredentials=!0,this._initialized=!0,n.resolve();else{var a=s.open(t.oauthLoginPage.replace(/{{\s*key\s*}}/g,e.key),"oauth",t.oauthWindowParameters);if(a)var c=s.setInterval(function(){if(a.closed)s.clearInterval(c),n.reject(new r({code:401}));else try{var e=a.location.hash.match(/access_token=([0-9a-f]+)/);e&&(this._token=e[1],this._initialized=!0,a.close(),s.clearInterval(c),n.resolve(this._token))}catch(t){}}.bind(this),100);else n.reject(new r({code:401}))}else n.reject(new r({message:"Either `options.key` or `options.token` Parameter Required"}));else n.reject(new r({message:"`options` Parameter Required"}))}.bind(this)),n.promise()},n.prototype.isInitialized=function(){return this._initialized},n.prototype.isInitiaized=n.prototype.isInitialized,n.prototype.getToken=function(){return this._token},n.prototype.withCredentials=function(){return this._withCredentials},t.cloud.client=new n,t.modules.define("cloud.client",[],function(e){e(t.cloud.client)}),t.modules.define("cloud.Error",["component.util"],function(e,t){var n={400:"Bad Request",401:"Not Authorized",403:"Forbidden",404:"Not Found",409:"Conflict",410:"Gone",421:"Locked",423:"Too Many Requests",500:"Internal Server Error"},i=function(e){t.extend(this,{code:400},e),this.message||(this.message=n[this.code]),Error.captureStackTrace?Error.captureStackTrace(this,i):this.stack=(new Error).stack};t.defineClass(i,Error,{toString:function(){return this.code+" "+this.message}}),e(i)}),t.cloud.dataSyncApi={openDatabase:function(e){return this._require(["cloud.dataSyncApi.Database"]).spread(function(t){return new t(e)})},getDatabaseCount:function(e){return this._require(["component.util","cloud.dataSyncApi.http"]).spread(function(t,n){return n.getDatabases(t.extend({limit:0,offset:0},e)).then(function(e){return e.data.total})})},getDatabaseMetadata:function(e){if(!e||!e.database_id)return this._fail("`options.database_id` Parameter Required");var t=this._castMetadata.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.getDatabases(e).then(function(e){return t(e.data)})})},listDatabaseMetadata:function(e){if(!e||"undefined"==typeof e.offset||"undefined"==typeof e.limit)return this._fail("`options.offset` and `options.limit` Parameters Required");var t=this._castMetadata.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.getDatabases(e).then(function(e){return e.data.items.map(t)})})},createDatabase:function(e){var t=this._fail.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.putDatabase(e).then(function(n){return e&&!e.ignore_existing&&200==n.code?t(409,'Database "'+e.database_id+'" Already Exists'):Number(n.headers.etag)},this)})},deleteDatabase:function(e){return this._require(["cloud.dataSyncApi.http"]).spread(function(t){return t.deleteDatabase(e).then(function(){return null})})},_require:function(e){var n=t.vow.defer();return t.modules.require(e,function(){n.resolve([].slice.call(arguments))}),n.promise()},_castMetadata:function(e){return{database_id:e.database_id,revision:e.revision,title:e.title,created:new Date(e.created),modified:new Date(e.modified),records_count:e.records_count,size:e.size}},_fail:function(e,n){n||(n=e,e=400);var i=t.vow.defer();return t.modules.require(["cloud.Error"],function(t){i.reject(new t({code:e,message:n}))}),i.promise()}},t.modules.define("cloud.dataSyncApi",[],function(e){e(t.cloud.dataSyncApi)}),t.modules.define("cloud.dataSyncApi.Conflict",["component.util"],function(e,t){var n=function(e){this._type=e.type,this._fieldChangeConflicts=e.field_change_conflicts};t.defineClass(n,{getType:function(){return this._type},getFieldChangeConflicts:function(){return this._fieldChangeConflicts}}),e(n)}),t.modules.define("cloud.dataSyncApi.Database",["cloud.dataSyncApi.config","cloud.dataSyncApi.http","cloud.client","cloud.dataSyncApi.Dataset","cloud.dataSyncApi.Transaction","cloud.dataSyncApi.Operation","cloud.dataSyncApi.politics","cloud.Error","component.util","vow"],function(e,t,n,i,r,o,s,a,c,u,d){function l(e,t,n){var i=t.operations,r=e.dryRun(t.base_revision,i);return conflicts=r.conflicts,conflicts.length&&n&&(i=a[n](i,conflicts),r=e.dryRun(t.base_revision,i),conflicts=r.conflicts),{operations:i,conflicts:conflicts,revisionHistory:r.revisionHistory}}var f=function(e){var t=d.defer(),i=t.reject.bind(t);return this._id=e.database_id,this._context=e.context,this._token=e.token,this._locked=!0,this._gone=null,this._dataset=null,this._pendingCallbacks=[],this._postDeltaFail=null,this._possiblyMissedDelta=null,this._listeners={update:[]},n.putDatabase(e).then(function(o){200!=o.code&&201!=o.code?i(new c({code:o.code})):n.getSnapshot(e).then(function(e){200==e.code?(this._dataset=r.json.deserialize(e.data),this._locked=!1,t.resolve(this)):i(new c({code:e.code}))},i,this)},i,this),t.promise()};u.defineClass(f,{on:function(e,t){if("undefined"==typeof this._listeners[e])throw new c({message:"Event `"+e+"` is not supported"});if("function"!=typeof t)throw new c({message:"`callback` parameter must be a function"});return this._listeners[e].push(t),this},off:function(e,t){if("undefined"==typeof this._listeners[e])throw new c({message:"Event `"+e+"` is not supported"});var n=this._listeners[e].indexOf(t);if(-1==n)throw new c({code:404,message:"Callback not found"});return this._listeners[e].splice(n,1),this},_notify:function(e,t){var n=(this._listeners[e]||[]).slice();n.forEach(function(e){e(t)})},update:function(){return this._executeExclusiveTask(this._explicitUpdate.bind(this))},_explicitUpdate:function(){return this._applyDeltas().then(function(e){return e},function(e){throw 410==e.code&&(this._gone=d.reject({code:410,message:"Database snapshot outdated"})),e},this)},_applyDeltas:function(){var e=d.defer(),i=[],r=this._id,o=this._context,s=this._token,a=this._dataset,u=this._notify.bind(this),l=function(d,f){n.getDeltas({database_id:r,base_revision:d,context:o,token:s,limit:t.deltaLimit}).then(function(t){if(200==t.code){i.push(t.data.items);var n=t.data.items.length?t.data.items[t.data.items.length-1].revision:t.data.revision;n==t.data.revision?(i=[].concat.apply([],i),i.length&&(a.applyDeltas(i),f(i[i.length-1].delta_id)),e.resolve(a.getRevision()),u("update",a.getRevision())):l(n,f)}else e.reject(new c({code:t.code}))},function(t){e.reject(t)})};return l(this._dataset.getRevision(),function(e){this._postDeltaFail&&e&&this._postDeltaFail==e&&(this._postDeltaFail=null,this._possiblyMissedDelta=e)}.bind(this)),e.promise()},_executeExclusiveTask:function(e){var t=d.defer();return this._pendingCallbacks.push([e,t]),this._locked||this._proceedPendingQueue(),t.promise()},_proceedPendingQueue:function(){var e=this._pendingCallbacks.shift(),t=e[0],n=e[1];this._locked=!0,this._gone?n.resolve(this._gone):t().then(function(e){n.resolve(e),this._locked=!1,this._pendingCallbacks.length&&this._proceedPendingQueue()},function(e){n.reject(e),this._locked=!1,this._pendingCallbacks.length&&this._proceedPendingQueue()},this)},getRevision:function(){return this._dataset.getRevision()},getDatabaseId:function(){return this._id},createTransaction:function(){return new o(this,function(e,t){return this._executeExclusiveTask(this._patch.bind(this,e,t))}.bind(this))},_patch:function(e,t){var n=d.defer(),i=this._dataset,r=e.delta_id,o=function(){n.resolve(i.getRevision())},a=function(e){e.postDeltaFail&&(this._postDeltaFail=e.postDeltaFail),n.reject(e)}.bind(this);if(this._possiblyMissedDelta&&e.delta_id==this._possiblyMissedDelta)this._possiblyMissedDelta=null,o();else{var u=l(this._dataset,e,t),f=u.operations,h=u.conflicts,p=u.revisionHistory,_={base_revision:this.getRevision(),delta_id:e.delta_id,changes:f.map(s.json.serialize)};h.length?a(new c({code:409,conflicts:h,revisionHistory:p})):f.length?this._postDeltas({database_id:this._id,delta_id:r,base_revision:this.getRevision(),context:this._context,token:this._token,data:_}).then(function(e){_.revision=e,i.applyDeltas([_]),o(),this._notify("update",e)},function(n){409==n.code?this._explicitUpdate().then(function(){this._patch(e,t).then(o,a)},a,this):a(n)},this):o()}return n.promise()},_postDeltas:function(e){var t=d.defer(),i=function(e){t.reject(e)};return n.postDeltas(e).then(function(n){200==n.code||201==n.code?t.resolve(Number(n.headers.etag)):(n.code>=500&&(n.postDeltaFail=e.delta_id),i(new c(n)))},function(t){t.postDeltaFail=e.delta_id,i(t)},this),t.promise()},getRecord:function(e,t){return this._dataset.getRecord(e,t)},getRecordsCount:function(){return this._dataset.getLength()},iterator:function(e){return this._dataset.iterator(e)},forEach:function(e,t,n){"string"!=typeof e&&(n=t,t=e,e=null);for(var i=this._dataset.iterator(e),r=i.next(),o=0;!r.done;)t.call(n||null,r.value,o++),r=i.next();return this},filter:function(e,t,n){this.forEach(function(i,r){e(i,r)&&t.call(n||null,i,r)})}}),e(f)}),t.modules.define("cloud.dataSyncApi.Dataset",["cloud.dataSyncApi.Record","cloud.dataSyncApi.Operation","cloud.dataSyncApi.FieldOperation","cloud.dataSyncApi.Conflict","cloud.Error","component.util"],function(e,t,n,i,r,o,s){function a(e){return Object.keys(e).reduce(function(t,n){return t[n]=Object.keys(e[n]).reduce(function(e,t){return e[t]=!0,e},{}),t},{})}function c(e){return e.map(function(e){return n.json.deserialize(e)})}var u=function(e,n){var i=this._index={};this._revision=Number(e),this._revisionHistory=[],this._records=n.map(function(e){e instanceof t||(e=new t(e));var n=e.getCollectionId(),r=e.getRecordId();if(i[n]||(i[n]={}),i[n][r])throw new o({message:"Record with `collection_id` and `record_id` provided already exists",collection_id:n,record_id:r});return i[n][r]=e,e})};u.json={deserialize:function(e){return new u(e.revision,e.records.items.map(function(e){return t.json.deserialize(e)}))}},s.defineClass(u,{getRecord:function(e,t){if(!e)throw new o({message:"`collection_id` Parameter Required"});if(!t)throw new o({message:"`record_id` Parameter Required"});return this._index[e]&&this._index[e][t]},getRevision:function(){return this._revision},getLength:function(){return this._records.length},iterator:function(e){var t=-1,n=this._records;return{next:function(){if(e){do t++;while(t<n.length&&n[t].getCollectionId()!=e)}else t++;return t<n.length?{value:n[t]}:{done:!0}}}},applyDeltas:function(e){var n=this._index,r=this._revisionHistory,s=this._revision;e.forEach(function(e){var a={};if(e.base_revision!=s)throw new o({message:"Incorrect delta base_revision"});e.changes.forEach(function(e){var r=e.collection_id,o=e.record_id;switch(a[r]||(a[r]={}),a[r][o]=!0,e.change_type){case"insert":case"set":n[r]||(n[r]={}),n[r][o]=t.json.deserialize(e,!0);break;case"delete":delete n[r][o];break;case"update":var s=n[r][o];e.changes.forEach(function(e){s.applyFieldOperation(i.json.deserialize(e))})}}),r.push({base_revision:e.base_revision,delta_id:e.delta_id,revision:e.revision,alteredRecords:a,changes:e.changes}),s=e.revision});var a=this._records=[];Object.keys(n).forEach(function(e){Object.keys(n[e]).forEach(function(t){a.push(n[e][t])})}),this._revision=s},ifModifiedSince:function(e){var t=e.collection_id,n=e.record_id,i=e.revision,r=this._locateRevision(i);if(-1!=r)for(var o=r;o<this._revisionHistory.length;o++){var s=this._revisionHistory[o];if(s.alteredRecords[t]&&s.alteredRecords[t][n])return!0}return!1},_locateRevision:function(e){for(var t=0;t<this._revisionHistory.length;t++)if(this._revisionHistory[t].base_revision==e)return t;return-1},dryRun:function(e,i){var o=[],s=a(this._index),c=this._index;return i.forEach(function(i,a){var u=i.getCollectionId(),d=i.getRecordId();if(this.ifModifiedSince({collection_id:u,record_id:d,revision:e}))o.push({index:a,conflict:new r({type:"both_modified",operation:i})});else switch(i.getType()){case"insert":s[u]&&s[u][d]?o.push({index:a,conflict:new r({type:"record_already_exists",operation:i})}):(s[u]||(s[u]={}),s[u][d]=t.json.deserialize(n.json.serialize(i),!0));break;case"set":s[u]||(s[u]={}),s[u][d]=t.json.deserialize(n.json.serialize(i),!0);break;case"delete":s[u]&&s[u][d]?delete s[u][d]:o.push({index:a,conflict:new r({type:"delete_non_existent_record",operation:i})});break;case"update":if(s[u]&&s[u][d]){var l=s[u][d],f=[];l===!0&&(l=c[u][d].copy()),i.getFieldOperations().forEach(function(e,t){var n=l.dryRun(e);n?f.push({type:n,index:t}):l.applyFieldOperation(e)}),f.length?o.push({index:a,conflict:new r({type:"invalid_field_change",operation:i,field_change_conflicts:f})}):s[u][d]=l}else o.push({index:a,conflict:new r({type:"update_non_existent_record",operation:i})})}},this),{conflicts:o,revisionHistory:o.length?this._getRevisionHistory(e):[]}},_getRevisionHistory:function(e){var t=this._locateRevision(e);if(-1!=t){for(var n=[],i=t;i<this._revisionHistory.length;i++){var r=this._revisionHistory[i];n.push({base_revision:r.base_revision,revision:r.revision,delta_id:r.delta_id,operations:c(r.changes)})}return n}return[]}}),e(u)}),t.modules.define("cloud.dataSyncApi.FieldOperation",["component.util","cloud.dataSyncApi.Value"],function(e,t,n){var i=function(e){this._type=e.type,this._fieldId=e.field_id,this._value=-1!=["set","list_item_set","list_item_insert"].indexOf(this._type)?e.value instanceof n?e.value:new n(e.value):null,this._index=-1!=["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(this._type)?Math.floor(e.index):null,this._newIndex="list_item_move"==this._type?Math.floor(e.new_index):null};i.json={serialize:function(e){var t=e.getType(),i={field_id:e.getFieldId(),change_type:t};return("set"==t||"list_item_set"==t||"list_item_insert"==t)&&(i.value=n.json.serialize(e.getValue())),"list_item_move"==t&&(i.list_item_dest=e.getNewIndex()),0==t.indexOf("list_item_")&&(i.list_item=e.getIndex()),i},deserialize:function(e){var t=e.change_type,r={type:t,field_id:e.field_id};return("set"==t||"list_item_set"==t||"list_item_insert"==t)&&(r.value=n.json.deserialize(e.value)),"list_item_move"==t&&(r.new_index=e.list_item_dest),0==t.indexOf("list_item_")&&(r.index=e.list_item),new i(r)}},t.defineClass(i,{getType:function(){return this._type},getFieldId:function(){return this._fieldId},getValue:function(){return this._value},getIndex:function(){return this._index},getNewIndex:function(){return this._newIndex}}),e(i)}),t.modules.define("cloud.dataSyncApi.Operation",["cloud.dataSyncApi.FieldOperation","cloud.dataSyncApi.Record","component.util"],function(e,t,n,i){var r=function(e){this._type=e.type,this._collectionId=e.collection_id,this._recordId=e.record_id,this._fieldOperations=-1!=["insert","update","set"].indexOf(this._type)?(e.field_operations||[]).map(function(e){return e instanceof t?e:new t(e)}):null};r.json={serialize:function(e){var n=e.getType(),i={record_id:e.getRecordId(),collection_id:e.getCollectionId(),change_type:n};return-1!=["insert","update","set"].indexOf(n)&&(i.changes=e.getFieldOperations().map(function(e){return t.json.serialize(e)})),i},deserialize:function(e){var n=e.change_type,i={type:n,record_id:e.record_id,collection_id:e.collection_id};return-1!=["insert","update","set"].indexOf(this._type)&&(i.field_changes=e.changes.map(function(e){return t.json.deserialize(e)})),new r(i)}},i.defineClass(r,{getType:function(){return this._type},getRecordId:function(){return this._recordId},getCollectionId:function(){return this._collectionId},getFieldOperations:function(){return this._fieldOperations?this._fieldOperations.slice():null}}),e(r)}),t.modules.define("cloud.dataSyncApi.Record",["cloud.Error","component.util","cloud.dataSyncApi.Value"],function(e,t,n,i){var r=function(e){this._collectionId=e.collection_id,this._recordId=e.record_id,this._fields=Object.keys(e.fields||{}).reduce(function(t,n){return t[n]=e.fields[n]instanceof i?e.fields[n]:new i(e.fields[n]),t},{})};r.json={deserialize:function(e,n){return new r(n?{collection_id:e.collection_id,record_id:e.record_id,fields:(e.changes||[]).reduce(function(e,n){if("set"!=n.change_type)throw new t({message:"Field change type is not supported",type:n.change_type});return e[n.field_id]=i.json.deserialize(n.value),e},{})}:{collection_id:e.collection_id,record_id:e.record_id,fields:e.fields.reduce(function(e,t){return e[t.field_id]=i.json.deserialize(t.value),e},{})})},serialize:function(e){return{record_id:e.getRecordId(),collection_id:e.getCollectionId(),change_type:"set",changes:e.getFieldIds().map(function(t){return{field_id:t,change_type:"set",value:i.json.serialize(e.getFieldValue(t))}})}}},n.defineClass(r,{getCollectionId:function(){return this._collectionId},getRecordId:function(){return this._recordId},getFieldIds:function(){return Object.keys(this._fields)},getFieldValue:function(e){return this._fields[e]},getFields:function(){return n.extend({},this._fields)},applyFieldOperation:function(e){var n=this.dryRun(e);if(n)throw new t({code:409,type:n});var i=e.getFieldId(),r=e.getType(),o=this._fields,s=o[i];return"set"==r?this._fields[i]=e.getValue():"delete"==r?delete this._fields[i]:-1!=["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(r)&&s.applyListOperation(e),this},copy:function(){var e=this._fields;return new r({collection_id:this.getCollectionId(),record_id:this.getRecordId(),fields:Object.keys(this._fields).reduce(function(t,n){return t[n]=e[n].copy(),t},{})})},dryRun:function(e){var t=e.getFieldId(),n=e.getType(),i=this._fields,r=i[t];return"set"==n?null:"delete"!=n?-1!=["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(n)?"undefined"==typeof r?"modify_non_existent_field":"list"!=r.getType()?"modify_not_a_list_field":r.dryRun(e):"unknown_type":"undefined"==typeof r?"delete_non_existent_field":null}}),e(r)}),t.modules.define("cloud.dataSyncApi.Transaction",["cloud.dataSyncApi.Record","cloud.dataSyncApi.Operation","cloud.dataSyncApi.FieldOperation","component.util"],function(e,t,n,i,r){function o(e,n){var i={type:e};return n instanceof t?(i.collection_id=n.getCollectionId(),i.record_id=n.getRecordId()):(i.collection_id=n.collection_id,i.record_id=n.record_id),i}var s=function(e,t){this._database=e,this._patchCallback=t,this._deltaId="ya_cloud_data_js_api_1_"+Math.random().toString(),this._baseRevision=e.getRevision(),this._operations=[]};r.defineClass(s,{addOperations:function(e){return[].push.apply(this._operations,[].concat(e).map(function(e){return e instanceof n?e:new n(e)})),this},push:function(e){return this._patchCallback({delta_id:this._deltaId,base_revision:this._baseRevision,operations:this._operations},e)},getDatabase:function(){return this._database},getBaseRevision:function(){return this._baseRevision},getOperations:function(){return this._operations.slice()},insertRecords:function(e){return this.addOperations([].concat(e).map(function(e){var r=o("insert",e);return r.field_operations=e instanceof t?e.getFieldIds().map(function(t){return new i({type:"set",field_id:t,value:e.getFieldValue(t)})}):e.fields?Object.keys(e.fields).map(function(t){return new i({type:"set",field_id:t,value:e.fields[t]})}):[],new n(r)}))},deleteRecords:function(e){return this.addOperations([].concat(e).map(function(e){return new n(o("delete",e))}))},setRecordFields:function(e,t){var r=o("set",e);return r.field_operations=Array.isArray(t)?t:Object.keys(t||{}).map(function(e){return new i({type:"set",field_id:e,value:t[e]})}),this.addOperations(new n(r))},updateRecordFields:function(e,t){var r=o("update",e);return r.field_operations=Array.isArray(t)?t:Object.keys(t).map(function(e){return new i("undefined"==typeof t[e]?{type:"delete",field_id:e}:{type:"set",field_id:e,value:t[e]})}),this.addOperations(new n(r))},insertRecordFieldListItem:function(e,t){var r=o("update",e);return r.field_operations=[new i({type:"list_item_insert",field_id:t.field_id,index:t.index,value:t.value})],this.addOperations(new n(r))
},setRecordFieldListItem:function(e,t){var r=o("update",e);return r.field_operations=[new i({type:"list_item_set",field_id:t.field_id,index:t.index,value:t.value})],this.addOperations(new n(r))},moveRecordFieldListItem:function(e,t){var r=o("update",e);return r.field_operations=[new i({type:"list_item_move",field_id:t.field_id,index:t.index,new_index:t.new_index})],this.addOperations(new n(r))},deleteRecordFieldListItem:function(e,t){var r=o("update",e);return r.field_operations=[new i({type:"list_item_delete",field_id:t.field_id,index:t.index})],this.addOperations(new n(r))}}),e(s)}),t.modules.define("cloud.dataSyncApi.Value",["component.util","cloud.Error"],function(t,n,i){function r(t){switch(typeof t){case"number":return t==Number.POSITIVE_INFINITY?"inf":t==Number.NEGATIVE_INFINITY?"ninf":e.isNaN(t)?"nan":"double";case"string":return"string";case"boolean":return"boolean";case"object":return null==t?"null":"undefined"!=typeof e.ArrayBuffer&&(t instanceof ArrayBuffer||t.buffer&&t.buffer instanceof ArrayBuffer)?"binary":t instanceof Date?"datetime":t instanceof Boolean?"boolean":t instanceof Number?"double":Array.isArray(t)?"list":"string";default:throw new i({message:"Type unknown"})}}function o(t,n){switch(t){case"string":return n.toString();case"integer":return Math.floor(Number(n));case"double":return Number(n);case"boolean":return n instanceof Boolean?n.valueOf():Boolean(n);case"datetime":return n instanceof Date?n.toISOString():n;case"binary":return"undefined"!=typeof e.ArrayBuffer?n instanceof ArrayBuffer?e.btoa(String.fromCharCode.apply(null,new Uint8Array(n))):n.buffer&&n.buffer instanceof ArrayBuffer?e.btoa(String.fromCharCode.apply(null,new Uint8Array(n.buffer))):n.toString():n.toString();case"null":return null;case"inf":return Number.POSITIVE_INFINITY;case"ninf":return Number.NEGATIVE_INFINITY;case"nan":return Number.NaN;case"list":return n.map(function(e){return e instanceof u?e:new u(e)});default:throw new i({message:"Type unknown"})}}function s(e,t){return"list"==e?t.map(function(e){return e.copy()}):t}function a(e){e=e.replace(/[^A-Za-z0-9\+\/]/g,"");for(var t,n,i=e.length,r=3*i+1>>2,o=new Uint8Array(r),s=0,a=0,u=0;i>u;u++)if(n=3&u,s|=c(e.charCodeAt(u))<<18-6*n,3==n||i-u==1){for(t=0;3>t&&r>a;t++,a++)o[a]=s>>>(16>>>t&24)&255;s=0}return o.buffer}function c(e){return e>64&&91>e?e-65:e>96&&123>e?e-71:e>47&&58>e?e+4:43==e?62:47==e?63:0}var u=function(e){e&&e.type?(this._type=e.type,this._value=o(this._type,e.value)):(this._type=r(e),this._value=o(this._type,e))};u.json={serialize:function(e){var t={};return t.type=e._type,-1!=["null","nan","inf","ninf"].indexOf(t.type)?t[t.type]=!0:"list"==t.type?t.list=e._value.map(u.json.serialize):t[t.type]=e._value,t},deserialize:function(e){var t={type:e.type};return"list"==e.type?t.value=e.list?e.list.map(u.json.deserialize):[]:-1==["null","nan","inf","ninf"].indexOf(e.type)&&(t.value=e[e.type]),new u(t)}},n.defineClass(u,{getType:function(){return this._type},valueOf:function(e){return e&&"binary"==this._type?a(this._value):"datetime"==this._type?new Date(this._value):this._value},toString:function(){return this._value.toString()},copy:function(){return new u({type:this._type,value:s(this._type,this._value)})},applyListOperation:function(e){var t=this.dryRun(e);if(t)throw new i({code:409,type:t});var n=e.getType(),r=e.getIndex(),o=this._value;switch(n){case"list_item_set":o[r]=e.getValue();break;case"list_item_move":var s=o[r],a=e.getNewIndex();r!=a&&(o.splice(r,1),o.splice(a,0,s));break;case"list_item_insert":o.splice(r,0,e.getValue());break;case"list_item_delete":o.splice(r,1)}return this},dryRun:function(e){var t=e.getType(),n=e.getIndex(),i=this._value;switch(t){case"list_item_set":if(n>=i.length||0>n)return"incorrect_list_index";break;case"list_item_move":var r=e.getNewIndex();if(n>=i.length||0>n||r>=i.length||0>r)return"incorrect_list_index";break;case"list_item_insert":if(n>i.length||0>n)return"incorrect_list_index";break;case"list_item_delete":if(n>=i.length||0>n)return"incorrect_list_index";break;default:return"unknown_type"}return null}}),t(u)}),t.modules.define("cloud.dataSyncApi.config",function(e){e({apiHost:"https://cloud-api.yandex.net/",contexts:{app:!0,user:!0},oauthLoginPage:"https://oauth.yandex.ru/authorize?response_type=token&client_id={{ key }}",oauthWindowParameters:"width=600,height=500",deltaLimit:100})}),t.modules.define("cloud.dataSyncApi.http",["cloud.dataSyncApi.config","cloud.client","component.xhr","component.util","vow","cloud.Error"],function(e,t,n,i,r,o,s){var a=function(e){return e?c(e.context)?void 0:u("Invalid `options.context` Value"):u("`options` Parameter Required")},c=function(e){return e&&t.contexts[e]},u=function(e,t){return t||(t=e,e=400),o.reject(new s({code:e,message:t}))},d=function(e,t){var i=r.extend({},t);return i.headers=i.headers?r.extend({},i.headers):{},e.token?(i.headers.Authorization="OAuth "+token,o.resolve(i)):n.isInitiaized()?(n.withCredentials()?i.withCredentials=!0:i.headers.Authorization="OAuth "+n.getToken(),o.resolve(i)):e&&(e.authorize_if_needed||"undefined"==typeof e.authorize_if_needed)?n.initialize(e).then(function(){return n.withCredentials()?i.withCredentials=!0:i.headers.Authorization="OAuth "+n.getToken(),i}):o.reject(new s({code:401}))};e({getDatabases:function(e){var n,r=t.apiHost+"v1/data/"+e.context+"/databases";return e&&e.database_id?r+="/"+e.database_id:n={limit:Number(e&&e.limit),offset:Number(e&&e.offset)},a(e)||d(e,{queryParams:n,parse:!0}).then(function(e){return i(r,e)})},putDatabase:function(e){var n=a(e);return n||"string"==typeof e.database_id||(n=u("`options.database_id` Parameter Required")),n||d(e,{method:"PUT",parse:!0}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id,n)})},deleteDatabase:function(e){var n=a(e);return n||"string"==typeof e.database_id||(n=u("`options.database_id` Parameter Required")),n||d(e,{method:"DELETE",parse:!1}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id,n)})},getSnapshot:function(e){return a(e)||d(e,{parse:!0}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/snapshot",n)})},getDeltas:function(e){var n=a(e);return n||"string"==typeof e.database_id||(n=u("`options.database_id` Parameter Required")),n||"number"==typeof e.base_revision||(n=u("`options.base_revision` Parameter Required")),n||d(e,{method:"GET",queryParams:{base_revision:e.base_revision,limit:"undefined"==typeof e.limit?100:e.limit},parse:!0}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/deltas",n)})},postDeltas:function(e){var n=a(e);return n||"string"==typeof e.database_id||(n=u("`options.database_id` Parameter Required")),n||"number"==typeof e.base_revision||(n=u("`options.base_revision` Parameter Required")),n||"object"==typeof e.data||(n=u("`options.data` Parameter Required")),n||d(e,{method:"POST",headers:{"If-Match":e.base_revision},parse:!0,data:e.data}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/deltas",n)})}})}),t.modules.define("cloud.dataSyncApi.politics",[],function(e){e({theirs:function(e,t){var n=t.reduce(function(e,t){return e[t.index]=!0,e},{}),i=[];return e.forEach(function(e,t){n[t]||i.push(e)}),i}})}),t.modules.define("component.util",function(e){var t={augment:function(e,n,i){return e.prototype=(Object.create||function(e){function t(){}return t.prototype=e,new t})(n.prototype),e.prototype.constructor=e,e.superclass=n.prototype,e.superclass.constructor=n,i&&t.extend(e.prototype,i),e.prototype},extend:function(e){for(var t=1,n=arguments.length;n>t;t++){var i=arguments[t];if(i)for(var r=Object.keys(i),o=0,s=r.length;s>o;o++)e[r[o]]=i[r[o]]}return e},defineClass:function(e){var n=1,i="function"==typeof arguments[n]?arguments[n++]:null;i&&t.augment(e,i);for(var r=arguments.length;r>n;)t.extend(e.prototype,arguments[n++]);return e}};e(t)}),t.modules.define("component.xhr",["global","vow","cloud.Error","cloud.dataSyncApi.config"],function(e,t,n,i){var r=t.XDomainRequest||t.XMLHttpRequest,o=function(e){return e.split("\r\n").reduce(function(e,t){var n=t.split(": ");return 2==n.length&&(e[n[0].toLowerCase()]=n[1].trim()),e},{})};e(function(e,s){s=s||{},s.queryParams&&(e+=(-1==e.indexOf("?")?"?":"&")+Object.keys(s.queryParams).map(function(e){return e+"="+t.encodeURIComponent(s.queryParams[e])}).join("&"));var a=n.defer(),c=new r,u=s.headers||{},d=s.method||"GET";return"GET"==d||u["Content-Type"]||(u["Content-Type"]="application/json"),u["X-Requested-With"]||(u["X-Requested-With"]="XMLHttpRequest"),s.withCredentials&&(c.withCredentials=!0),c.onload=function(){var e={code:this.status,data:this.responseText,headers:"undefined"==typeof s.parseResponseHeaders||s.parseResponseHeaders?o(this.getAllResponseHeaders()):this.getAllResponseHeaders()};if(s.parse)try{e.data=JSON.parse(e.data)}catch(t){a.reject(new i({message:"JSON Parse Error "+e.data}))}a.resolve(e)},c.onerror=function(){a.reject(new i({code:500}))},c.open(d,e,!0),Object.keys(u).forEach(function(e){c.setRequestHeader(e,u[e])}),c.send("undefined"!=typeof s.data?"string"==typeof s.data?s.data:JSON.stringify(s.data):void 0),a.promise().timeout(s.timeout||3e4).fail(function(e){throw e instanceof n.TimedOutError?new i({code:500,message:"Timeout Exceeded"}):e})})}),t.modules.define("global",function(t){t(e)}),"object"==typeof module)module.exports=t;else{var i=e.ya||(e.ya={});i.modules=t.modules,i.vow=t.vow,i.cloud=t.cloud}}(this);